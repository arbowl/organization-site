{% extends "base.html" %}
{% from 'macros/post_cards.html' import post_card, post_card_list %}
{% block title %}Posts by {{ user.username }} | Dismantl{% endblock %}

{% block content %}
<div class="text-center mb-8">
  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 max-w-2xl text-center mx-auto">
        {% for category, message in messages %}
          <div class="p-3 mb-2 rounded-md
              {% if category == 'success' %}bg-green-100 text-green-800 border border-green-200
              {% elif category == 'error' %}bg-red-100 text-red-800 border border-red-200
              {% elif category == 'info' %}bg-blue-100 text-blue-800 border border-blue-200
              {% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}
          ">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h3 class="text-gray-600 mt-1">{{ user.role_icon }}{{ user.role.capitalize() }}</h3>
  <div class="flex justify-center items-center gap-2">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-0">{{ user.username }}</h1>
    {% if current_user.is_authenticated and current_user.username != user.username %}
      {% if not current_user.subscribed_to_user(user) %}
      ‚∏±
        <form method="post" action="{{ url_for('social.subscribe_user', username=user.username) }}" class="inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 transition">
            üîî Follow
          </button>
        </form>
      {% else %}
        <form method="post" action="{{ url_for('social.unsubscribe_user', username=user.username) }}" class="inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 transition">
            üîï Unfollow
          </button>
        </form>
      {% endif %}
    {% endif %}
  </div>
  
</div>


{% if current_user.is_authenticated and current_user.username == user.username %}
  <div class="max-w-2xl mx-auto mb-6 bg-gray-50 p-6 rounded-lg border border-t-4 border-r-2 border-blue-300">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Profile</h2>

    <form method="post" action="{{ url_for('account.update_preferences') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <div class="space-y-4 text-left">
        <label class="flex items-center space-x-2">
          <input type="checkbox" name="newsletter" {% if current_user.newsletter %}checked{% endif %}>
          <span class="text-gray-700">Subscribe to the Dismantl newsletter</span>
        </label>

        <label class="flex items-center space-x-2">
          <input type="checkbox" name="email_notifications" {% if current_user.email_notifications %}checked{% endif %}>
          <span class="text-gray-700">Receive email notifications for replies and new posts</span>
        </label>
      </div>

      <button type="submit" class="mt-4 inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
        Save Preferences
      </button>
    </form>
  </div>
{% endif %}

{# Bio Display Section - shown to all visitors #}
{% if user.bio_text or user.location or user.website or user.social_links %}
<div class="max-w-2xl mx-auto mb-6 bg-white p-6 rounded-lg border border-t-4 border-r-2 border-green-300">
  <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
    <span class="mr-2">üë§</span>
    About {{ user.username }}
  </h2>
  
  <div class="space-y-4">
    {% if user.bio_html %}
    <div class="prose prose-sm max-w-none">
      {{ user.bio_html | safe }}
    </div>
    {% endif %}
    
    <div class="flex flex-wrap gap-4 text-sm text-gray-600">
      {% if user.location %}
      <div class="flex items-center">
        <span class="mr-1">üìç</span>
        <span>{{ user.location }}</span>
      </div>
      {% endif %}
      
      {% if user.website %}
      <div class="flex items-center">
        <span class="mr-1">üåê</span>
        <a href="{{ user.website }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800">
          Website
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

{# Bio Editing Section - shown only to profile owner #}
{% if current_user.is_authenticated and current_user.username == user.username %}
<div class="max-w-2xl mx-auto mb-6 bg-gray-50 p-6 rounded-lg border border-t-4 border-r-2 border-green-300">
  <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
    <span class="mr-2">‚úèÔ∏è</span>
    Edit Your Bio
  </h2>

  <form method="post" action="{{ url_for('account.update_bio') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="space-y-4 text-left">
      <div>
        <label for="bio_text" class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
        <textarea 
          name="bio_text" 
          id="bio_text" 
          rows="6" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Tell us about yourself... (Markdown supported)"
          maxlength="1000"
        >{{ user.bio_text or '' }}</textarea>
        
        <!-- Character counter -->
        <div class="text-sm text-gray-500 mt-1">
          <span id="bio-char-count" class="font-semibold text-gray-700">0</span> / 
          <span id="bio-max-chars" class="font-semibold text-gray-700">1000</span>
        </div>
        
        <p class="text-xs text-gray-500 mt-1">You can use Markdown formatting.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Location</label>
          <input 
            type="text" 
            name="location" 
            id="location" 
            value="{{ user.location or '' }}"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="e.g., Boston, MA"
          >
        </div>

        <div>
          <label for="website" class="block text-sm font-medium text-gray-700 mb-2">Website</label>
          <input 
            type="url" 
            name="website" 
            id="website" 
            value="{{ user.website or '' }}"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="https://yourwebsite.com"
          >
        </div>
      </div>


    </div>

    <button type="submit" class="mt-4 inline-flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
      Save Bio
    </button>
  </form>
</div>
{% endif %}

<div class="max-w-2xl mx-auto mb-4 bg-white p-6 rounded-lg border transition-shadow duration-300 border-t-4 border-r-2 border-blue-300">

  {# Tabs Navigation #}
  <nav class="mb-4 border-b">
    {% for t, label in [('posts', 'Posts'), ('comments', 'Comments')] %}
      <a href="{{ url_for('blog.user_posts', username=user.username, tab=t) }}"
         class="inline-block px-3 py-2 {{ 'border-b-2 border-blue-600 font-semibold' if active_tab == t else 'text-gray-600 hover:text-gray-800' }}">
        {{ label }}
      </a>
    {% endfor %}
  </nav>

  {# Posts Tab #}
  {% if active_tab == 'posts' %}
    {% if posts_entries %}
      {{ post_card_list(posts_entries, show_author=False) }}

      {# Pagination #}
        {% set pagination = posts_pagination %}
        {% set url = url_for('blog.user_posts', username=user.username, tab='posts') %}
        {% include 'includes/pagination.html' %}
    {% else %}
      <p class="text-center text-gray-600 italic mt-8">{{ user.username }} hasn't written any posts yet.</p>
    {% endif %}
  {% endif %}

  {# Comments Tab #}
  {% if active_tab == 'comments' %}
    {% if comments_entries %}
      <ul class="space-y-6">
        {% for comment in comments_entries %}
          <li class="bg-white p-6 rounded-lg border border-t-2 border-l-2 border-teal-200 hover:shadow-md transition">
            <p class="text-gray-800 text-md mb-2">"{{ comment.content | md | striptags | truncate(120, True, '...') }}"</p>
            <small class="text-gray-700 text-sm block"> 
              {% if comment.bill_id %}
                <a href="{{ url_for('bills.view_bill', bill_slug=comment.bill.slug) }}" class="text-blue-600 hover:underline">{{ comment.bill.bill_number }}</a>
              {% else %}
                <a href="{{ url_for('blog.view_post', slug=comment.post.slug) }}" class="text-blue-600 hover:underline">{{ comment.post.title }}</a>
              {% endif %}
              on {{ comment.timestamp | format_date }}
            </small>
          </li>
        {% endfor %}
      </ul>

      {# Pagination #}
        {% set pagination = comments_pagination %}
        {% set url = url_for('blog.user_posts', username=user.username, tab='comments') %}
        {% include 'includes/pagination.html' %}
    {% else %}
      <p class="text-center text-gray-600 italic mt-8">{{ user.username }} hasn't made any comments yet.</p>
    {% endif %}
  {% endif %}
</div>

<br>
<br>
<br>
{% endblock %}

